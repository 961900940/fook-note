## php内核

内容为阅读《php7内核解析》，做的笔记。

### PHP的构成

PHP的源码下有几个主要目录：SAPI、main、Zend、ext。

- SAPI是PHP的应用接口层。
- main为PHP的主要代码，主要是输入/输出、web通信，以及PHP框架的初始化操作等。
- Zend是PHP的解析器的主要实现，即ZendVM，它是PHP语言的核心实现。
- ext是PHP的扩展目录。

### PHP的生命周期

- 模块初始化阶段
- 请求初始化阶段
- 执行脚本阶段
- 请求关闭阶段
- 模块关闭阶段

### 面向对象

面向对象编程，简称OOP，是一种程序设计思路。面向对象吧对象作为程序的基本单元，一个对象包含了数据和操作数据的函数。

面向对象的特点：

- 封装：将类中的成员属性和方法结合成一个独立的单位，确保类以外的部分不能随意存取类的内部数据。
- 继承：一个类可以继承并拥有另外一个类的成员属性和成员方法。
- 多肽：程序能够处理多种类型对象的能力，PHP中可以通过继承和接口两种方式实现多肽。

### 类

一个类可以包含属于自己的常量、变量（称为“属性”）与函数（称为“方法”），在面向对象中的编程中，类是对象的抽象，对象是类的具体实例。

#### 常量

PHP中可以把在类中始终保持不变的值定义为常量，常量的值必须是一个定值。

```php
class my_class{
    const CONST_NAME = const_value;
    public function __construct(){
        self::CONST_NAME;
    }
}
my_class::CONST_NAME;
```

#### 成员属性

类的属性由关键字 public、protected和private开头，属性中的变量可以初始化，但初始化的值必须是固定不变的值，不能是变量，初始化值在编译阶段时就可以得到其值，而不依赖于运行时的信息才能求值。

#### 成员方法

分为静态方法和动态方法。

#### 类的自动加载

类的自动加载实际上就是内核提供的一个钩子函数，实例化类时如果在EG（class_table）中没有找到对应的类，则会调用这个钩子函数，调用完以后再重新查找一次。

PHP中提供了两种方式实现自动加载，__autoload(),spl_autoload_register()。

spl_autoload_register

相比__autoload只能定义一个加载器，spl_autoload_register提供类更加灵活的注册方式，可以支持任意数量的加载器，比如在不同lib库的文件名规则。

在实现上，spl创建类一个队列来保存用户注册的加载器，然后定义类一个spl_autoload_call函数到EG，当找不到类时，内核回调spl_autoload_call，这个函数在依次调用用户注册的加载器。

#### 魔术方法

- __construct()
- __destruct()
- __call()
- __callStatic()
- __get()
- __set()
- __isset()
- __unset()
- __sleep()
- __wakeup()
- __toString()
- __invoke()
- __set_state()
- __clone()
- __debugInfo()

### 命名空间

命名空间主来用来解决两类问题：

- 用户编写的代码与PHP内部的或第三方的类、函数、变量、接口命名冲突。
- 为很长的标识符名称创建一个别名的名称，提高源代码的可读性。
- PHP命名空间只能隔离类、函数、常量和接口，不包括全局变量。

### PHP基础语法的实现

#### 静态变量（static）

静态变量和普通变量的存储结构不同，保存在zend_op_array->static_variables中，是一种哈希结构。静态变量只会初始化一次，而且他的初始化发生在变异阶段而不是执行阶段。因为这个特性，静态变量的初始不能是个变量。但在执行阶段，可以动态赋值。

```php
function my_func(){
    static $count = 4;
    $count++;
    echo $count;
}
my_func();
my_func();
//输出5
//输出6
```

上面代码中，在编译阶段静态变量就会初始化一次，而在执行阶段不会在设置该值。在执行阶段，改变值后，内存不会被回收，所以两次输出结果不同。

#### 常量（const define）

常量是一种简单值的标识符，在脚本执行期间该值不能改变。

常量默认大小写敏感，通常常量标识符总是大写的。合法的常量名以字母或下划线开始，后面跟着任何字母、数字和下划线。

##### const关键字

```
const AA = 100;
const AA = 100, BB = 200;
```

##### define函数

define可以定义值为变量的常量，但是变量的值必须也是标量。

```
$a = array(1,2);
define('AA', $a);
```